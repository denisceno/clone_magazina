{% extends "base.html" %}
{% load static %}

{% block title %}Dalje nga Magazina{% endblock %}

{% block extra_css %}
<link rel="stylesheet" href="{% static 'inventory/css/withdrawal_form.css' %}">
{% endblock %}

{% block body %}

<div class="withdrawal-page">

  <div class="page-header">
    <h2>Dalje nga Magazina</h2>
  </div>

  {% if error %}
    <div class="panel-card error-card">
      <strong>Gabim:</strong> {{ error }}
    </div>
  {% endif %}

  <div class="withdrawal-layout">

    <!-- LEFT: ALL PRODUCTS TABLE -->
    <section class="left-panel">
      <div class="panel-card">
        <form class="search-bar" id="left-search-form">
          <input
            type="text"
            id="left-live-search"
            placeholder="K√´rko Materialin..."
            autocomplete="off"
          />
        </form>

        <div class="table-wrapper">
          <table class="styled-table" id="left-products-table">
            <thead>
              <tr>
                <th>Emri</th>
                <th>Gjendje</th>
                <th class="th-add">+</th>
              </tr>
            </thead>

            <tbody>
              {% for p in products %}
              <tr
                class="product-row"
                data-id="{{ p.id }}"
                data-name="{{ p.name }}"
                data-name-lower="{{ p.name|lower }}"
                data-stock="{{ p.quantity }}"
                data-unit="{{ p.unit }}"
                data-unit-display="{% if p.unit != 'pcs' %}{{ p.get_unit_display }}{% endif %}"
                data-depot="{{ p.depot.name }}"
              >
                <td>
                  <div class="p-name">{{ p.name }}</div>
                  <div class="p-meta">Magazina: {{ p.depot.name }}</div>
                </td>

                <td class="p-stock">
                  <span class="stock-text">
                    {{ p.quantity }}{% if p.unit != "pcs" %} {{ p.get_unit_display }}{% endif %}
                  </span>
                </td>

                <td class="p-add">
                  <button type="button" class="btn-add-mini" title="Shto">+</button>
                </td>
              </tr>
              {% empty %}
              <tr id="left-no-results-row">
                <td colspan="3" class="no-results">No products found</td>
              </tr>
              {% endfor %}
            </tbody>

          </table>
        </div>
      </div>
    </section>

    <!-- RIGHT: WITHDRAWAL FORM -->
    <section class="right-panel">
      <div class="panel-card">
        <h3 class="right-title">Dalja</h3>

        <form method="POST" id="withdrawal-form">
          {% csrf_token %}

          <div class="top-grid">
            <div>{{ header_form.employee }}</div>
            {{ header_form.date }}
          </div>

          <div class="notes-box">{{ header_form.notes }}</div>

          <div class="items-box">
            <ul id="items-list" class="items-list"></ul>
          </div>

          {{ formset.management_form }}
          <div id="hidden-items"></div>

          <button type="submit" class="submit-btn">Regjistro Daljen</button>
        </form>
      </div>
    </section>

  </div>
</div>

<div class="qty-modal" id="qty-modal" aria-hidden="true">
  <div class="qty-modal__backdrop" id="qty-backdrop"></div>

  <div class="qty-modal__dialog" role="dialog" aria-modal="true" aria-labelledby="qty-title">
    <div class="qty-modal__header">
      <div>
        <div class="qty-modal__title" id="qty-title">Shto Produkt</div>
        <div class="qty-modal__sub" id="qty-sub">‚Äî</div>
      </div>
      <button type="button" class="qty-modal__close" id="qty-close" aria-label="Close">‚úï</button>
    </div>

    <div class="qty-modal__body">
      <div class="qty-row">
        <label for="qty-modal-input">Sasia</label>
        <input type="number" id="qty-modal-input" min="1" autocomplete="off" />
      </div>

      <div class="qty-hint" id="qty-hint"></div>
      <div class="qty-warning" id="qty-warning" style="display:none;"></div>
    </div>

    <div class="qty-modal__footer">
      <button type="button" class="btn-light" id="qty-cancel">Anulo</button>
      <button type="button" class="btn-primary" id="qty-confirm">Shto</button>
    </div>
  </div>
</div>

<script>
  // ---------- ELEMENTS ----------
  const leftSearch = document.getElementById("left-live-search");
  const leftForm = document.getElementById("left-search-form");
  const leftTable = document.getElementById("left-products-table");
  const leftRows = leftTable ? leftTable.querySelectorAll("tbody .product-row") : [];
  const leftNoRow = document.getElementById("left-no-results-row");

  const listBox = document.getElementById("items-list");
  const hiddenItems = document.getElementById("hidden-items");
  const totalForms = document.getElementById("id_form-TOTAL_FORMS");

  // Modal
  const modal = document.getElementById("qty-modal");
  const modalBackdrop = document.getElementById("qty-backdrop");
  const modalClose = document.getElementById("qty-close");
  const modalCancel = document.getElementById("qty-cancel");
  const modalConfirm = document.getElementById("qty-confirm");
  const modalInput = document.getElementById("qty-modal-input");
  const modalSub = document.getElementById("qty-sub");
  const modalHint = document.getElementById("qty-hint");
  const modalWarn = document.getElementById("qty-warning");

  let currentProduct = null;

  // Prevent Enter submit in left search
  leftForm?.addEventListener("submit", (e) => e.preventDefault());

  // ---------- FILTER (LEFT SEARCH) ----------
  function filterLeftRows() {
    const q = (leftSearch.value || "").trim().toLowerCase();
    let visible = 0;

    leftRows.forEach((row) => {
      const name = row.dataset.nameLower || "";
      const depot = (row.dataset.depot || "").toLowerCase();
      const match = (name + " " + depot).includes(q);

      row.style.display = match ? "" : "none";
      if (match) visible++;
    });

    if (leftNoRow) leftNoRow.style.display = (visible === 0) ? "" : "none";
  }

  leftSearch?.addEventListener("input", filterLeftRows);
  filterLeftRows();

  // ---------- STOCK UI HELPERS ----------
  function getUnitDisplay(row) {
    const unit = row.dataset.unit;
    const unitDisplay = row.dataset.unitDisplay || "";
    return unit === "pcs" ? "" : unitDisplay;
  }

  function renderStockCell(row) {
    const stock = parseInt(row.dataset.stock || "0", 10);
    const unitTxt = getUnitDisplay(row);
    const cell = row.querySelector(".stock-text");
    if (cell) cell.textContent = `${stock}${unitTxt ? " " + unitTxt : ""}`;

    // If no stock, visually disable add button
    const btn = row.querySelector(".btn-add-mini");
    if (btn) {
      btn.disabled = stock <= 0;
      btn.style.opacity = stock <= 0 ? "0.4" : "1";
      btn.style.cursor = stock <= 0 ? "not-allowed" : "pointer";
    }
  }

  // initial render (in case you want button disable on 0)
  leftRows.forEach(renderStockCell);

  // ---------- FORMSET REINDEX ----------
  function reindexFormset() {
    const items = listBox.querySelectorAll("li");
    items.forEach((li, newIdx) => {
      li.dataset.idx = newIdx;

      const productInput = hiddenItems.querySelector(
        `input[data-role="product"][data-id="${li.dataset.id}"]`
      );
      const qtyInputEl = hiddenItems.querySelector(
        `input[data-role="quantity"][data-id="${li.dataset.id}"]`
      );

      if (productInput) productInput.name = `form-${newIdx}-product`;
      if (qtyInputEl) qtyInputEl.name = `form-${newIdx}-quantity`;
    });

    totalForms.value = items.length;
  }

  // ---------- MODAL OPEN/CLOSE ----------
  function openModal(productRow) {
    currentProduct = productRow;

    const name = productRow.dataset.name;
    const depot = productRow.dataset.depot;
    const stock = parseInt(productRow.dataset.stock || "0", 10);
    const unit = productRow.dataset.unit;
    const unitDisplay = productRow.dataset.unitDisplay || "";

    modalSub.textContent = `${name} ‚Ä¢ Magazina: ${depot}`;

    modalHint.innerHTML = `Gjendje: <strong>${stock}</strong> ${unit === "pcs" ? "" : unitDisplay}`;

    modalWarn.style.display = "none";
    modalWarn.innerHTML = "";

    modalInput.value = "";
    modalInput.max = String(stock); // ‚úÖ Withdrawal must NOT exceed stock

    modal.classList.add("active");
    modal.setAttribute("aria-hidden", "false");
    setTimeout(() => modalInput.focus(), 50);
  }

  function closeModal() {
    modal.classList.remove("active");
    modal.setAttribute("aria-hidden", "true");
    currentProduct = null;
  }

  modalBackdrop.addEventListener("click", closeModal);
  modalClose.addEventListener("click", closeModal);
  modalCancel.addEventListener("click", closeModal);

  document.addEventListener("keydown", (e) => {
    if (e.key === "Escape" && modal.classList.contains("active")) closeModal();
  });

  // Confirm with Enter
  modalInput.addEventListener("keydown", (e) => {
    if (e.key === "Enter") {
      e.preventDefault();
      modalConfirm.click();
    }
  });

  // Live warning if qty > stock
  modalInput.addEventListener("input", () => {
    if (!currentProduct) return;
    const stock = parseInt(currentProduct.dataset.stock || "0", 10);
    const qty = parseInt(modalInput.value || "0", 10);

    if (!qty || qty <= 0) {
      modalWarn.style.display = "none";
      modalWarn.innerHTML = "";
      return;
    }

    if (qty > stock) {
      modalWarn.style.display = "block";
      modalWarn.innerHTML = `‚ö†Ô∏è Stock i pamjaftuesh√´m. Gjendje: <strong>${stock}</strong>.`;
      modalWarn.style.cssText =
        "display:block; margin-top:10px; padding:10px 12px; border-radius:12px; border:1px solid #ef444433; background:#fef2f2; color:#991b1b; font-size:13px; line-height:1.3;";
    } else {
      modalWarn.style.display = "none";
      modalWarn.innerHTML = "";
    }
  });

  // ---------- CLICK + (LEFT TABLE) ----------
  leftTable?.addEventListener("click", (e) => {
    const btn = e.target.closest(".btn-add-mini");
    if (!btn || btn.disabled) return;

    const row = btn.closest(".product-row");
    if (!row) return;

    const stock = parseInt(row.dataset.stock || "0", 10);
    if (stock <= 0) return alert("Nuk ka gjendje p√´r k√´t√´ produkt.");

    const id = row.dataset.id;
    if (document.querySelector(`li[data-id="${id}"]`)) {
      return alert("Produkti √´sht√´ shtuar!");
    }

    openModal(row);
  });

  // ---------- ADD ITEM ----------
  modalConfirm.addEventListener("click", () => {
    if (!currentProduct) return;

    const id = currentProduct.dataset.id;
    const name = currentProduct.dataset.name;
    const unit = currentProduct.dataset.unit;
    const depot = currentProduct.dataset.depot;
    const stock = parseInt(currentProduct.dataset.stock || "0", 10);

    const qty = parseInt(modalInput.value || "0", 10);
    if (!qty || qty <= 0) return alert("Vendos sasi valide.");
    if (qty > stock) return alert(`Stock i pamjaftuesh√´m! Gjendje: ${stock}`);

    const idx = parseInt(totalForms.value || "0", 10);

    // UI list item
    const li = document.createElement("li");
    li.dataset.id = id;
    li.dataset.qty = qty;
    li.dataset.unit = unit;
    li.dataset.depot = depot;
    li.dataset.idx = idx;

    li.innerHTML = `
      <span>
        <strong>${name}</strong>
        <small class="item-depot">Magazina: ${depot}</small>
      </span>
      <span class="right-actions">
        <span class="qty-display">${qty}</span>
        <span class="unit-display">${unit}</span>
        <button type="button" class="icon-btn icon-edit" title="Ndrysho">‚úèÔ∏è</button>
        <button type="button" class="icon-btn icon-remove" title="Hiq">üóëÔ∏è</button>
      </span>
    `;
    listBox.appendChild(li);

    // hidden formset inputs
    hiddenItems.insertAdjacentHTML(
      "beforeend",
      `
        <input type="hidden" data-role="product" data-id="${id}" name="form-${idx}-product" value="${id}">
        <input type="hidden" data-role="quantity" data-id="${id}" name="form-${idx}-quantity" value="${qty}">
      `
    );

    totalForms.value = idx + 1;

    // ‚úÖ deduct stock in left table immediately
    currentProduct.dataset.stock = String(stock - qty);
    renderStockCell(currentProduct);

    closeModal();
  });

  // ---------- REMOVE ----------
  listBox.addEventListener("click", (e) => {
    const removeBtn = e.target.closest(".icon-remove");
    if (!removeBtn) return;

    const li = e.target.closest("li");
    const id = li.dataset.id;
    const qty = parseInt(li.dataset.qty || "0", 10);

    // restore stock in left table
    const row = leftTable.querySelector(`.product-row[data-id="${id}"]`);
    if (row) {
      const stock = parseInt(row.dataset.stock || "0", 10);
      row.dataset.stock = String(stock + qty);
      renderStockCell(row);
    }

    hiddenItems.querySelector(`input[data-role="product"][data-id="${id}"]`)?.remove();
    hiddenItems.querySelector(`input[data-role="quantity"][data-id="${id}"]`)?.remove();

    li.remove();
    reindexFormset();
  });

  // ---------- EDIT QTY ----------
  listBox.addEventListener("click", (e) => {
    const editBtn = e.target.closest(".icon-edit");
    if (!editBtn) return;

    const li = e.target.closest("li");
    const id = li.dataset.id;
    const oldQty = parseInt(li.dataset.qty || "0", 10);

    const row = leftTable.querySelector(`.product-row[data-id="${id}"]`);
    const remainingStock = row ? parseInt(row.dataset.stock || "0", 10) : 0;

    // available = remaining + oldQty (because oldQty is already reserved)
    const available = remainingStock + oldQty;

    const newQty = parseInt(prompt(`Sasia e re (max ${available}):`, oldQty) || "0", 10);
    if (!newQty || newQty <= 0) return;
    if (newQty > available) return alert(`Stock i pamjaftuesh√´m! Max: ${available}`);

    // update li + hidden input
    li.dataset.qty = newQty;
    li.querySelector(".qty-display").textContent = newQty;

    const hiddenQty = hiddenItems.querySelector(
      `input[data-role="quantity"][data-id="${id}"]`
    );
    if (hiddenQty) hiddenQty.value = newQty;

    // update stock on left row
    if (row) {
      row.dataset.stock = String(available - newQty);
      renderStockCell(row);
    }
  });
</script>

{% endblock %}
